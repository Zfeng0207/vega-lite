{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 1200,
  "height": 500,
  "padding": {"left": 5, "right": 200, "top": 5, "bottom": 5},
  "autosize": "none",
  "title": {
    "text": "Malaysia Labour Force Participation Rate by State (2019â€“2022)",
    "fontSize": 16,
    "anchor": "start"
  },
  "signals": [
    {
      "name": "year_select",
      "value": 2022,
      "bind": {
        "input": "range",
        "min": 2019,
        "max": 2022,
        "step": 1,
        "name": "Select Year: "
      }
    },
    {
      "name": "sex_select",
      "value": "both",
      "bind": {
        "input": "select",
        "options": ["both", "male", "female"],
        "labels": ["Both Sexes", "Male", "Female"],
        "name": "Select Sex: "
      }
    }
  ],
  "data": [
    {
      "name": "lf_raw",
      "url": "https://raw.githubusercontent.com/Zfeng0207/vega-lite/refs/heads/main/data/lfs_state_sex_cleaned.csv",
      "format": {
        "type": "csv",
        "parse": {
          "date": "date",
          "lf": "number",
          "lf_employed": "number",
          "lf_unemployed": "number",
          "lf_outside": "number",
          "p_rate": "number",
          "u_rate": "number",
          "ep_ratio": "number"
        }
      }
    },
    {
      "name": "lf_year",
      "source": "lf_raw",
      "transform": [
        {"type": "formula", "expr": "year(datum.date)", "as": "year"},
        {
          "type": "filter",
          "expr": "datum.year == year_select && datum.sex == sex_select && datum.state != 'W.P. Kuala Lumpur' && datum.state != 'W.P. Labuan'"
        }
      ]
    },
    {
      "name": "states_geo",
      "url": "https://raw.githubusercontent.com/Zfeng0207/VegaLite/refs/heads/main/ne_10m_admin_1_states_provinces.json",
      "format": {"type": "topojson", "feature": "states"}
    },
    {
      "name": "states_with_data",
      "source": "states_geo",
      "transform": [
        {
          "type": "formula",
          "expr": "datum.properties.Name == 'Penang' ? 'Pulau Pinang' : datum.properties.Name",
          "as": "state_name"
        },
        {
          "type": "filter",
          "expr": "datum.state_name != 'W.P. Kuala Lumpur' && datum.state_name != 'W.P. Labuan'"
        },
        {
          "type": "lookup",
          "from": "lf_year",
          "key": "state",
          "fields": ["state_name"],
          "values": ["p_rate", "year", "sex"],
          "as": ["p_rate", "year", "sex"]
        }
      ]
    },
    {
      "name": "graticule",
      "transform": [
        {"type": "graticule", "extent": [[95, -5], [118, 8]], "step": [2, 2]}
      ]
    }
  ],
  "projections": [
    {
      "name": "projection",
      "type": "mercator",
      "center": [103.7, 4],
      "scale": 2700,
      "translate": [400, 250]
    }
  ],
  "scales": [
    {
      "name": "color",
      "type": "sequential",
      "domain": [40, 85],
      "range": ["#e5f5e0", "#31a354"],
      "clamp": true
    }
  ],
"legends": [
  {
    "fill": "color",
    "type": "gradient",
    "title": "Participation Rate (%)",
    "orient": "none",       
    "direction": "vertical",
    "gradientLength": 100,
    "gradientThickness": 10,
    "format": ".1f",
    "titleFontSize": 10,
    "labelFontSize": 10,
    "encode": {
      "legend": {
        "update": {
          "x": {"value": 500},   
          "y": {"value": 100}    
        }
      }
    }
  }
  ],
  "marks": [
    {
      "type": "shape",
      "from": {"data": "graticule"},
      "encode": {
        "update": {
          "strokeWidth": {"value": 0.8},
          "stroke": {"value": "#e6e6e6"},
          "fill": {"value": null}
        }
      },
      "transform": [{"type": "geoshape", "projection": "projection"}]
    },
    {
      "type": "shape",
      "from": {"data": "states_with_data"},
      "encode": {
        "update": {
          "strokeWidth": {"value": 0.5},
          "stroke": {"value": "white"},
          "fill": [
            {
              "test": "datum.p_rate != null",
              "scale": "color",
              "field": "p_rate"
            },
            {"value": "#ddd"}
          ],
          "tooltip": {
            "signal": "{'State': datum.properties.Name, 'Year': year_select, 'Sex': sex_select, 'Participation Rate (%)': format(datum.p_rate, '.1f')}"
          }
        }
      },
      "transform": [{"type": "geoshape", "projection": "projection"}]
    },
    {
      "type": "text",
      "from": {"data": "states_with_data"},
      "encode": {
        "update": {
          "x": {"signal": "geoCentroid('projection', datum)[0]"},
          "y": {"signal": "geoCentroid('projection', datum)[1]"},
          "text": {
            "signal": "isValid(datum.p_rate) ? format(datum.p_rate, '.1f') + '%' : ''"
          },
          "align": {"value": "center"},
          "baseline": {"value": "middle"},
          "fontSize": {"value": 10},
          "fontWeight": {"value": "bold"},
          "fill": {"value": "#222"},
          "stroke": {"value": "black"},
          "strokeWidth": {"value": 0.5}
        }
      }
    }
  ],
  "config": {"view": {"stroke": null}}
}